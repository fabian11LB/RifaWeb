<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Rifa Amor y Amistad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* (Estilos CSS sin cambios... se mantienen los de la respuesta anterior) */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Segoe UI, Arial, Helvetica, sans-serif; }
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #fce4ec; }
        .raffle-container { position: relative; width: 100%; max-width: 720px; }
        .raffle-container img#background-image { width: 100%; height: auto; display: block; }
        .raffle-container svg#overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* -- ESTILOS SVG ACTUALIZADOS -- */
        .raffle-cell {
            fill: transparent;
            stroke: rgba(0, 0, 0, 0.1);
            stroke-width: 1px;
            cursor: pointer;
            transition: fill 0.2s;
        }
        .raffle-cell-group.sold .raffle-cell {
            fill: rgba(229, 57, 53, 0.45);
            cursor: not-allowed;
        }
        /* Estilo para la 'X' de vendido */
        .sold-mark {
            font-family: Arial, sans-serif;
            font-size: 50px; /* Tamaño de la 'X' */
            fill: #b71c1c; /* Color rojo oscuro para la 'X' */
            text-anchor: middle; /* Centrado horizontal */
            dominant-baseline: central; /* Centrado vertical */
            pointer-events: none; /* La 'X' no interfiere con los clics */
        }

        /* (Estilos del Modal sin cambios...) */
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.55); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; }
        .modal.visible { display: flex; }
        .modal-content { background: #fff; padding: 1.2rem 1.5rem; border-radius: 8px; text-align: center; max-width: 320px; }
        .modal-content img { width: 100%; max-width: 250px; margin: 0.8rem 0; }
        .modal-content button { padding: 0.6rem 1.2rem; border: none; background: #d40055; color: #fff; border-radius: 4px; cursor: pointer; font-size: 1rem; }
    </style>
</head>
<body>

    <div class="raffle-container">
        <img id="background-image" src="fondo.png" alt="Fondo de la Rifa">
        <svg id="overlay" viewBox="0 0 720 1280" preserveAspectRatio="xMidYMid meet"></svg>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="qrTitle">Número 00</h3>
            <img id="qrImage" src="qrnequi.png" alt="Código QR de Nequi">
            <br>
            <button id="closeModal">Cerrar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const TOTAL_NUMBERS = 100;
            const gridCoords = { x: 87.50, y: 561.13, width: 545.00, height: 513.00 };
            const cellCoords = { width: 54.00, height: 51.00 };

            const svgOverlay = document.getElementById('overlay');
            const modal = document.getElementById('modal');
            const qrTitle = document.getElementById('qrTitle');
            const closeModalBtn = document.getElementById('closeModal');
            
            // El Set de números vendidos ahora se carga desde el archivo JSON
            let soldNumbers = new Set();

            /**
             * Carga los números vendidos desde el archivo 'vendidos.json'.
             * Esta es la "fuente de la verdad" para todos los visitantes.
             */
            async function loadSoldNumbers() {
                try {
                    const response = await fetch('vendidos.json?cachebust=' + new Date().getTime());
                    if (!response.ok) throw new Error('No se encontró el archivo de vendidos.');
                    const soldArray = await response.json();
                    soldNumbers = new Set(soldArray.map(String));
                } catch (error) {
                    console.warn(error.message, "Mostrando la rifa sin números vendidos.");
                    soldNumbers = new Set();
                }
                // (Opcional) Guardar en localStorage para el admin
                localStorage.setItem('soldRaffleNumbers', JSON.stringify([...soldNumbers]));
            }

            /**
             * Genera la cuadrícula interactiva en el SVG.
             */
            function createRaffleGrid() {
                svgOverlay.innerHTML = ''; // Limpiar la cuadrícula antes de volver a dibujarla
                for (let i = 0; i < TOTAL_NUMBERS; i++) {
                    const row = Math.floor(i / 10);
                    const col = i % 10;
                    const x = gridCoords.x + (col * cellCoords.width);
                    const y = gridCoords.y + (row * cellCoords.height);

                    // Crear un grupo para la celda y la 'X'
                    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    group.classList.add('raffle-cell-group');
                    group.dataset.number = i;

                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x);
                    rect.setAttribute('y', y);
                    rect.setAttribute('width', cellCoords.width);
                    rect.setAttribute('height', cellCoords.height);
                    rect.classList.add('raffle-cell');
                    
                    group.appendChild(rect);

                    if (soldNumbers.has(i.toString())) {
                        group.classList.add('sold');
                        
                        // Añadir la 'X' si el número está vendido
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', x + cellCoords.width / 2);
                        text.setAttribute('y', y + cellCoords.height / 2);
                        text.classList.add('sold-mark');
                        text.textContent = 'X';
                        group.appendChild(text);
                    } else {
                        // Solo los grupos no vendidos deben ser clickeables
                        group.addEventListener('click', handleCellClick);
                    }
                    
                    svgOverlay.appendChild(group);
                }
            }
            
            function handleCellClick(event) {
                const group = event.currentTarget; // El evento está en el grupo
                const number = group.dataset.number;
                showModal(number);
            }

            function showModal(number) {
                qrTitle.textContent = `Número ${number.toString().padStart(2, '0')}`;
                modal.classList.add('visible');
            }
            
            function hideModal() { modal.classList.remove('visible'); }
            closeModalBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (event) => { if (event.target === modal) hideModal(); });

            // --- FUNCIONES DE ADMINISTRADOR ---

            /**
             * (Admin) Marca un número como vendido, actualizando localStorage.
             */
            function sellNumber(numberStr) {
                const number = parseInt(numberStr, 10);
                if (isNaN(number) || number < 0 || number >= TOTAL_NUMBERS) {
                    alert('Por favor, introduce un número válido entre 00 y 99.');
                    return;
                }
                
                const localSoldNumbers = new Set(JSON.parse(localStorage.getItem('soldRaffleNumbers') || '[]'));
                const numAsString = number.toString();

                if (localSoldNumbers.has(numAsString)) {
                    alert(`El número ${numAsString.padStart(2, '0')} ya estaba vendido.`);
                    return;
                }

                localSoldNumbers.add(numAsString);
                localStorage.setItem('soldRaffleNumbers', JSON.stringify([...localSoldNumbers]));
                
                // Actualiza visualmente la cuadrícula para el admin
                soldNumbers = localSoldNumbers;
                createRaffleGrid();

                alert(`¡Número ${numAsString.padStart(2, '0')} marcado como vendido localmente! Presiona 'E' para exportar.`);
            }

            /**
             * (Admin) Exporta los números vendidos de localStorage a un archivo JSON.
             */
            function exportSoldNumbers() {
                const localSoldNumbers = localStorage.getItem('soldRaffleNumbers') || '[]';
                const blob = new Blob([localSoldNumbers], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vendidos.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Archivo "vendidos.json" descargado. Súbelo a tu repositorio de GitHub.');
            }

            window.addEventListener('keydown', function(e) {
                // Tecla 'V' para VENDER (solo para el admin)
                if (e.key.toLowerCase() === 'v') {
                    const numberToSell = prompt('ADMIN: ¿Qué número vendiste? (00-99)');
                    if (numberToSell !== null && numberToSell.trim() !== '') {
                        sellNumber(numberToSell);
                    }
                }

                // Tecla 'E' para EXPORTAR (solo para el admin)
                if (e.key.toLowerCase() === 'e') {
                    if (confirm('ADMIN: ¿Quieres descargar el archivo "vendidos.json" con los cambios actuales?')) {
                        exportSoldNumbers();
                    }
                }
            });

            // --- INICIALIZACIÓN ---
            await loadSoldNumbers(); // Cargar los datos del archivo
            createRaffleGrid();      // Dibujar la cuadrícula con los datos cargados
        });
    </script>

</body>
</html>
